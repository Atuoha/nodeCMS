'use strict';const express=require("express"),router=express.Router(),Post=require("../../models/Post"),faker=require("faker"),{isEmpty,uploadDir}=require("../../helpers/upload-helper"),path=require("path"),fs=require("fs"),Category=require("../../models/Category");router.all("/*",(a,d,c)=>{a.app.locals.layout="admin";c()});router.get("/",(a,d)=>{Post.find({}).populate("category").then(c=>{d.render("admin/posts",{posts:c})}).catch(c=>console.log("Post Error: err"))});
router.get("/create",(a,d)=>{Category.find().then(c=>{d.render("admin/posts/create-post",{categories:c})})});
router.post("/create",(a,d)=>{var c=[];a.body.title||c.push({message:"Please add title"});a.body.body||c.push({message:"Please add body"});a.body.sub||c.push({message:"Please add sub title"});if(0<c.length)d.render("admin/posts/create-post",{errors:c});else{c=Date.now()+"-img_place.png";isEmpty(a.files)||(file=a.files.file,c=Date.now()+"-"+file.name,file.mv("./public/uploads/"+c,e=>{if(e)throw e;}));let b=!0;b=a.body.allowComments?!0:!1;(new Post({title:a.body.title,sub:a.body.sub,status:a.body.status,
category:a.body.category,allowComments:b,file:c,body:a.body.body,date:new Date})).save().then(e=>{console.log(`Sent Post: ${e}`);a.flash("success_msg",`Post :${e.title} has been created :)`);d.redirect("/admin/posts")}).catch(e=>console.log(e))}});router.get("/:id/edit",(a,d)=>{Post.findOne({_id:a.params.id}).then(c=>{Category.find().then(b=>{console.log(`Single post: ${c}`);d.render("admin/posts/edit",{post:c,categories:b});console.log(b)})})});
router.post("/:id/update",(a,d)=>{let c=!0;c=a.body.allowComments?!0:!1;Post.findOne({_id:a.params.id}).then(b=>{console.log(b);let e=b.file;if(!isEmpty(a.files)){let f=a.files.file;e=Date.now()+"-"+f.name;f.mv("./public/uploads/"+e,g=>{if(g)throw g;})}b.title=a.body.title;b.sub=a.body.sub;b.status=a.body.status;b.category=a.body.category;b.body=a.body.body;b.allowComments=c;b.file=e;b.save().then(f=>{console.log(`New Post: ${f}`);console.log("Updated Successfully");a.flash("success_msg",`Post has successfully been updated. New title is ${f.title}`);
d.redirect("/admin/posts")}).catch(f=>console.log(`Updating Error from: ${f}`))}).catch(b=>console.log(`Error from: ${b}`))});
router.get("/:id/delete",(a,d)=>{Post.findOne({_id:a.params.id}).then(c=>{console.log(c);"img_place.png"!==c.file&&fs.unlink("./public/uploads/"+c.file,b=>{if(b)throw b;});c.delete().then(b=>{console.log(`Post Deleted: ${b}`);a.flash("success_msg",`${b.title} has been deleted without errors :)`);d.redirect("/admin/posts")}).catch(b=>console.log(`Deleting Error from: ${b}`))}).catch(c=>console.log(`Error: ${c}`))});router.get("/dummy",(a,d)=>{d.render("admin/dummy")});
router.post("/generate-fake-posts",(a,d)=>{for(let c=0;c<a.body.number;c++){let b=new Post;b.title=faker.name.title();b.sub=faker.random.words();b.category=faker.lorem.word();b.status="public";b.allowComments=faker.random.boolean();b.body=faker.lorem.sentence();b.file="img_place.png";b.date=new Date;b.save().then(e=>{console.log(e);a.flash("success_msg",`Created ${a.body.number} dummy post(s) :)`);d.redirect("/admin/posts")}).catch(e=>console.log(e))}});module.exports=router;